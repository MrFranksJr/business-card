<<<<<<< HEAD
'use strict';
const path = require('path');
const fs = require('fs');
const commonDir = require('commondir');
const pkgDir = require('pkg-dir');
const makeDir = require('make-dir');
=======
import process from 'node:process';
import path from 'node:path';
import fs from 'node:fs';
import commonPathPrefix from 'common-path-prefix';
import {packageDirectorySync} from 'pkg-dir';
>>>>>>> fa47191a6b4b2c8a8128a2e24375183fa9ea8081

const {env, cwd} = process;

const isWritable = path => {
	try {
		fs.accessSync(path, fs.constants.W_OK);
		return true;
<<<<<<< HEAD
	} catch (_) {
=======
	} catch {
>>>>>>> fa47191a6b4b2c8a8128a2e24375183fa9ea8081
		return false;
	}
};

function useDirectory(directory, options) {
	if (options.create) {
<<<<<<< HEAD
		makeDir.sync(directory);
=======
		fs.mkdirSync(directory, {recursive: true});
>>>>>>> fa47191a6b4b2c8a8128a2e24375183fa9ea8081
	}

	if (options.thunk) {
		return (...arguments_) => path.join(directory, ...arguments_);
	}

	return directory;
}

function getNodeModuleDirectory(directory) {
	const nodeModules = path.join(directory, 'node_modules');

	if (
<<<<<<< HEAD
		!isWritable(nodeModules) &&
		(fs.existsSync(nodeModules) || !isWritable(path.join(directory)))
=======
		!isWritable(nodeModules)
			&& (fs.existsSync(nodeModules) || !isWritable(path.join(directory)))
>>>>>>> fa47191a6b4b2c8a8128a2e24375183fa9ea8081
	) {
		return;
	}

	return nodeModules;
}

<<<<<<< HEAD
module.exports = (options = {}) => {
=======
export default function findCacheDirectory(options = {}) {
>>>>>>> fa47191a6b4b2c8a8128a2e24375183fa9ea8081
	if (env.CACHE_DIR && !['true', 'false', '1', '0'].includes(env.CACHE_DIR)) {
		return useDirectory(path.join(env.CACHE_DIR, options.name), options);
	}

	let {cwd: directory = cwd()} = options;

	if (options.files) {
<<<<<<< HEAD
		directory = commonDir(directory, options.files);
	}

	directory = pkgDir.sync(directory);
=======
		directory = commonPathPrefix(options.files.map(file => path.resolve(directory, file)));
	}

	directory = packageDirectorySync({cwd: directory});
>>>>>>> fa47191a6b4b2c8a8128a2e24375183fa9ea8081

	if (!directory) {
		return;
	}

	const nodeModules = getNodeModuleDirectory(directory);
	if (!nodeModules) {
<<<<<<< HEAD
		return undefined;
	}

	return useDirectory(path.join(directory, 'node_modules', '.cache', options.name), options);
};
=======
		return;
	}

	return useDirectory(path.join(directory, 'node_modules', '.cache', options.name), options);
}
>>>>>>> fa47191a6b4b2c8a8128a2e24375183fa9ea8081
